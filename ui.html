<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --font: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      --mono: 'IBM Plex Mono', 'Courier New', monospace;

      --bg:         #F7F8FC;
      --surface:    #FFFFFF;
      --elevated:   #EEF0F8;
      --border:     #DDE1EE;
      --border-dim: #E9EBF5;

      --text-1: #1A1D2E;
      --text-2: #6B7390;
      --text-3: #9DA5BF;

      --accent:      #4F6FE8;
      --accent-bg:   rgba(79, 111, 232, 0.08);
      --accent-glow: rgba(79, 111, 232, 0.20);

      --critical:    #E03131;
      --critical-bg: rgba(224, 49, 49, 0.07);
      --critical-bd: rgba(224, 49, 49, 0.20);

      --warning:    #7048C8;
      --warning-bg: rgba(112, 72, 200, 0.07);
      --warning-bd: rgba(112, 72, 200, 0.20);

      --resolved:    #2F9E44;
      --resolved-bg: rgba(47, 158, 68, 0.07);
      --resolved-bd: rgba(47, 158, 68, 0.20);

      /* Reason: Text style */
      --c-ts:    #1971C2;
      --c-ts-bg: rgba(25, 113, 194, 0.08);
      --c-ts-bd: rgba(25, 113, 194, 0.20);

      /* Reason: Text style ãŒæ··åœ¨ */
      --c-tm:    #C96B00;
      --c-tm-bg: rgba(201, 107, 0, 0.08);
      --c-tm-bd: rgba(201, 107, 0, 0.20);

      /* Reason: Fill color */
      --c-fill:    #C2255C;
      --c-fill-bg: rgba(194, 33, 92, 0.08);
      --c-fill-bd: rgba(194, 33, 92, 0.20);

      /* Reason: Stroke color */
      --c-stroke:    #0C8599;
      --c-stroke-bg: rgba(12, 133, 153, 0.08);
      --c-stroke-bd: rgba(12, 133, 153, 0.20);
    }

    html.dark {
      --bg:         #14151B;
      --surface:    #1C1E27;
      --elevated:   #252836;
      --border:     #2D3045;
      --border-dim: #232636;

      --text-1: #E8EAF2;
      --text-2: #8B93B0;
      --text-3: #5E6680;

      --accent:      #5B82F5;
      --accent-bg:   rgba(91, 130, 245, 0.12);
      --accent-glow: rgba(91, 130, 245, 0.25);

      --critical:    #FF5263;
      --critical-bg: rgba(255, 82, 99, 0.10);
      --critical-bd: rgba(255, 82, 99, 0.30);

      --warning:    #9D7FEA;
      --warning-bg: rgba(157, 127, 234, 0.10);
      --warning-bd: rgba(157, 127, 234, 0.30);

      --resolved:    #00C97A;
      --resolved-bg: rgba(0, 201, 122, 0.10);
      --resolved-bd: rgba(0, 201, 122, 0.30);

      --c-ts:    #5B9EF5;
      --c-ts-bg: rgba(91, 158, 245, 0.12);
      --c-ts-bd: rgba(91, 158, 245, 0.30);

      --c-tm:    #F0943A;
      --c-tm-bg: rgba(240, 148, 58, 0.12);
      --c-tm-bd: rgba(240, 148, 58, 0.30);

      --c-fill:    #F060EC;
      --c-fill-bg: rgba(240, 96, 236, 0.12);
      --c-fill-bd: rgba(240, 96, 236, 0.30);

      --c-stroke:    #22D3EE;
      --c-stroke-bg: rgba(34, 211, 238, 0.12);
      --c-stroke-bd: rgba(34, 211, 238, 0.30);
    }

    html, body {
      height: 100%;
      font-family: var(--font);
      font-size: 14px;
      background: var(--bg);
      color: var(--text-1);
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes spin { to { transform: rotate(360deg); } }

    @keyframes cardIn {
      from { opacity: 0; transform: translateY(5px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes scanBlink {
      0%, 100% { opacity: 0.5; }
      50%      { opacity: 1; }
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      flex-shrink: 0;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 11px 14px;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .app-title {
      height: 20px;
      width: auto;
      display: block;
      font-weight: bold;
      margin-right: 5px;
    }

    .btn-group { display: flex; gap: 6px; }

    .btn {
      font-family: var(--font);
      font-size: 13px;
      font-weight: 700;
      padding: 5px 13px;
      border-radius: 4px;
      border: 1px solid var(--border);
      cursor: pointer;
      line-height: 1.5;
      white-space: nowrap;
      transition: background 0.15s, color 0.15s, border-color 0.15s, box-shadow 0.15s;
    }

    /* Scan button â€” solid fill */
    .btn-primary {
      background: var(--accent);
      color: #FFFFFF;
      border-color: var(--accent);
    }
    .btn-primary:hover {
      background: var(--accent);
      opacity: 0.88;
    }
    .btn-primary:active {
      opacity: 0.75;
    }
    .btn-primary:disabled {
      opacity: 0.3;
      cursor: default;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-2);
      border-color: transparent;
    }
    .btn-ghost:hover {
      color: var(--text-1);
      background: var(--elevated);
    }

    .btn-soft {
      background: var(--elevated);
      color: var(--text-1);
      border-color: var(--border);
      font-size: 12px;
      padding: 4px 5px;
    }
    .btn-soft:hover {
      background: var(--border);
      color: var(--text-1);
      border-color: var(--border);
    }
    .btn-soft:disabled {
      opacity: 0.3;
      cursor: default;
    }

    .btn-toggle-on {
      background: var(--accent);
      color: #FFFFFF;
      border-color: var(--accent);
      font-size: 12px;
      padding: 4px 5px;
    }
    .btn-toggle-on:hover {
      opacity: 0.88;
    }

    #btn-auto-scan {
      width: auto;
      min-width: auto;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 6px;
      line-height: 1.3;
      text-align: center;
    }

    /* â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #summary-wrap {
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
    }

    .summary-placeholder {
      padding: 10px 14px;
      font-size: 12px;
      color: var(--text-3);
      background: var(--surface);
      letter-spacing: 0.04em;
      animation: scanBlink 2.4s ease-in-out infinite;
    }

    .summary-loading {
      padding: 10px 14px;
      font-size: 12px;
      color: var(--accent);
      background: var(--surface);
      display: flex;
      align-items: center;
      gap: 7px;
      letter-spacing: 0.04em;
    }

    .spinner {
      width: 11px; height: 11px;
      border: 1.5px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      flex-shrink: 0;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      padding: 8px 14px 10px;
      background: var(--surface);
    }

    .stat {
      padding: 8px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-top: 2px solid var(--border);
      border-radius: 4px;
      position: relative;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-2);
      font-weight: 400;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .stat-num {
      font-size: 20px;
      font-weight: 700;
      line-height: 1;
      color: var(--text-1);
    }

    .stat.is-critical { border-top-color: var(--critical); border-color: var(--critical-bd); background: var(--critical-bg); }
    .stat.is-critical .stat-num { color: var(--critical); }

    .stat.is-warning { border-top-color: var(--warning); border-color: var(--warning-bd); background: var(--warning-bg); }
    .stat.is-warning .stat-num { color: var(--warning); }

    .stat.is-resolved { border-top-color: var(--resolved); border-color: var(--resolved-bd); background: var(--resolved-bg); }
    .stat.is-resolved .stat-num { color: var(--resolved); }

    /* â”€â”€ List header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #list-header-wrap { flex-shrink: 0; }

    .list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 14px 4px;
    }

    .list-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-2);
      letter-spacing: 0.07em;
      text-transform: uppercase;
    }

    .list-count {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-2);
      background: var(--elevated);
      border: 1px solid var(--border);
      padding: 1px 8px;
      border-radius: 3px;
      letter-spacing: 0.04em;
    }

    /* â”€â”€ Layer list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #layer-list {
      flex: 1;
      overflow-y: auto;
      padding: 6px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      list-style: none;
    }

    #layer-list::-webkit-scrollbar { width: 3px; }
    #layer-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }
    #layer-list::-webkit-scrollbar-track { background: transparent; }

    /* Staggered card animation */
    #layer-list > li { animation: cardIn 0.2s ease both; }
    #layer-list > li:nth-child(2)   { animation-delay:  40ms; }
    #layer-list > li:nth-child(3)   { animation-delay:  80ms; }
    #layer-list > li:nth-child(4)   { animation-delay: 120ms; }
    #layer-list > li:nth-child(5)   { animation-delay: 160ms; }
    #layer-list > li:nth-child(6)   { animation-delay: 200ms; }
    #layer-list > li:nth-child(7)   { animation-delay: 240ms; }
    #layer-list > li:nth-child(n+8) { animation-delay: 280ms; }

    /* â”€â”€ Layer card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 2px solid var(--border);
      border-radius: 8px;
      padding: 10px 11px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
    }

    .card:hover {
      background: var(--elevated);
      border-color: var(--border);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .card.critical {
      border-left-color: var(--critical);
      border-color: var(--critical-bd);
      background: var(--critical-bg);
    }
    .card.critical:hover {
      border-left-color: var(--critical);
      border-color: var(--critical-bd);
      background: var(--critical-bg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .card.warning {
      border-left-color: var(--warning);
      border-color: var(--warning-bd);
      background: var(--warning-bg);
    }
    .card.warning:hover {
      border-left-color: var(--warning);
      border-color: var(--warning-bd);
      background: var(--warning-bg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .card.resolved {
      border-left-color: var(--resolved);
      border-color: var(--resolved-bd);
      background: var(--resolved-bg);
    }
    .card.resolved:hover {
      border-left-color: var(--resolved);
      border-color: var(--resolved-bd);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .card-head {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
    }

    .layer-name {
      flex: 1;
      min-width: 0;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .type-pill {
      flex-shrink: 0;
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 800;
      color: var(--text-1);
      background: var(--elevated);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 1px 5px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .layer-path {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-2);
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.4;
      letter-spacing: 0.01em;
    }

    /* â”€â”€ Issue list (ã‚«ãƒ¼ãƒ‰å†…ã®å•é¡Œãƒªã‚¹ãƒˆ) â”€â”€â”€â”€ */
    .issue-list {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .issue-row {
      display: flex;
      align-items: center;
      gap: 7px;
      min-height: 28px;
      padding: 8px 0;
      border-top: 1px solid var(--border);
    }

    .issue-row:first-child {
      border-top: none;
    }

    .issue-row:last-child {
      padding-bottom: 0;
    }

    .card.critical .issue-row { border-color: var(--critical-bd); }
    .card.warning .issue-row { border-color: var(--warning-bd); }
    .card.resolved .issue-row { border-color: var(--resolved-bd); }

    /* å€™è£œã‚¹ã‚¿ã‚¤ãƒ«åãƒãƒƒãƒ— */
    .issue-val {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-1);
      background: var(--elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 3px 9px;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* å€™è£œãªã—ãƒ©ãƒ™ãƒ« */
    .no-cand-label {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--warning);
      background: var(--warning-bg);
      border: 1px solid var(--warning-bd);
      border-radius: 4px;
      padding: 3px 10px;
    }

    /* é©ç”¨ãƒœã‚¿ãƒ³ã‚’å³ç«¯ã«å¯„ã›ã‚‹ */
    .issue-row .apply-btn {
      margin-left: auto;
      flex-shrink: 0;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã¯é¸æŠã—ã‚„ã™ã„ã‚ˆã† text ã‚«ãƒ¼ã‚½ãƒ« */
    .layer-name, .layer-path, .issue-val { cursor: text; }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid transparent;
      white-space: nowrap;
      letter-spacing: 0.02em;
    }

    .badge-ts     { color: var(--c-ts);     background: var(--c-ts-bg);     border-color: var(--c-ts-bd); }
    .badge-tm     { color: var(--c-tm);     background: var(--c-tm-bg);     border-color: var(--c-tm-bd); }
    .badge-fill   { color: var(--c-fill);   background: var(--c-fill-bg);   border-color: var(--c-fill-bd); }
    .badge-stroke { color: var(--c-stroke); background: var(--c-stroke-bg); border-color: var(--c-stroke-bd); }
    .badge-ok     { color: var(--resolved); background: var(--resolved-bg); border-color: var(--resolved-bd); }

    /* Severity pill */
    .sev-pill {
      flex-shrink: 0;
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      padding: 2px 7px;
      border-radius: 3px;
      border: 1px solid transparent;
    }
    .sev-pill.critical {
      color: var(--critical);
      background: var(--critical-bg);
      border-color: var(--critical-bd);
    }
    .sev-pill.warning {
      color: var(--warning);
      background: var(--warning-bg);
      border-color: var(--warning-bd);
    }
    .sev-pill.resolved {
      color: var(--resolved);
      background: var(--resolved-bg);
      border-color: var(--resolved-bd);
    }

    .jump-btn {
      font-family: var(--mono);
      flex-shrink: 0;
      padding: 4px 11px;
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
      background: var(--accent-bg);
      border: 1px solid var(--accent-glow);
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.12s, border-color 0.12s;
      letter-spacing: 0.04em;
    }
    .jump-btn:hover {
      background: var(--accent-bg);
      border-color: var(--accent);
      opacity: 0.85;
    }

    .apply-btn {
      font-family: var(--font);
      flex-shrink: 0;
      padding: 4px 11px;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-1);
      background: var(--elevated);
      border: 1px solid var(--border);
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.12s, color 0.12s, border-color 0.12s;
    }

    .apply-btn:hover {
      background: var(--border);
      border-color: var(--border);
      color: var(--text-1);
    }

    .apply-btn:disabled {
      cursor: default;
      opacity: 0.4;
    }

    .apply-btn.applying {
      color: var(--text-3);
      background: var(--bg);
      border-color: var(--border-dim);
    }

    .apply-btn.applied {
      color: var(--resolved);
      background: var(--resolved-bg);
      border-color: var(--resolved-bd);
      opacity: 1;
    }

    .style-select {
      font-size: 11px;
      color: var(--text-1);
      background: var(--elevated);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 3px 5px;
      flex: 1;
      min-width: 0;
      cursor: pointer;
      outline: none;
      transition: border-color 0.12s;
    }

    .style-select:focus {
      border-color: var(--accent);
    }

    html.dark .style-select {
      color-scheme: dark;
    }

    /* â”€â”€ State boxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #layer-list > li.state-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      padding: 24px;
      text-align: center;
    }

    .state-icon  { font-size: 28px; margin-bottom: 6px; opacity: 0.8; }
    .state-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-2);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .state-desc {
      font-size: 13px;
      color: var(--text-2);
      line-height: 1.7;
    }

    /* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .legend {
      flex-shrink: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 6px 13px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }

    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 12px;
      align-items: center;
    }

    .leg {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-2);
      letter-spacing: 0.04em;
    }

    .leg-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
      opacity: 0.85;
    }

    /* â”€â”€ Legend controls row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .legend-controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      width: 100%;
    }

    /* â”€â”€ Theme toggle button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .theme-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 19px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--elevated);
      color: var(--text-2);
      cursor: pointer;
      flex-shrink: 0;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .theme-btn:hover {
      background: var(--border);
      color: var(--text-1);
    }

    .theme-icon { display: flex; }
    .theme-icon-sun { display: none; }
    html.dark .theme-icon-moon { display: none; }
    html.dark .theme-icon-sun  { display: flex; }

    /* â”€â”€ Auto-scan toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .auto-scan-label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      flex-shrink: 0;
      user-select: none;
    }

    .auto-scan-text {
      font-size: 11px;
      color: var(--text-2);
      letter-spacing: 0.04em;
      white-space: nowrap;
    }

    .toggle-switch {
      position: relative;
      width: 34px;
      height: 19px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-track {
      position: absolute;
      inset: 0;
      border-radius: 10px;
      background: var(--border);
      transition: background 0.2s;
    }

    .toggle-track::after {
      content: '';
      position: absolute;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: #FFFFFF;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.18);
    }

    .toggle-switch input:checked + .toggle-track {
      background: var(--accent);
    }

    .toggle-switch input:checked + .toggle-track::after {
      transform: translateX(15px);
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-row">
      <span class="app-title">LSChecker</span>
      <div class="btn-group">
        <button class="btn btn-soft" id="btn-apply-all" disabled>ä¸€æ‹¬é©ç”¨ï¼ˆ0ï¼‰</button>
        <button class="btn btn-primary" id="btn-scan">ã‚¹ã‚­ãƒ£ãƒ³</button>
      </div>
    </div>
  </header>

  <div id="summary-wrap">
    <div class="summary-placeholder">â–¸ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ã‚¹ã‚­ãƒ£ãƒ³</div>
  </div>

  <div id="list-header-wrap"></div>

  <ul id="layer-list">
    <li class="state-box">
      <div class="state-icon">ğŸ”</div>
      <div class="state-title">æœªã‚¹ã‚­ãƒ£ãƒ³</div>
      <div class="state-desc">ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ã‹ã‚‰<br>ã€Œã‚¹ã‚­ãƒ£ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    </li>
  </ul>

  <footer class="legend">
    <div class="legend-controls">
      <label class="auto-scan-label" for="btn-auto-scan">
        <span class="auto-scan-text">è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³</span>
        <span class="toggle-switch">
          <input type="checkbox" id="btn-auto-scan">
          <span class="toggle-track"></span>
        </span>
      </label>
      <button class="theme-btn" id="btn-theme" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
        <span class="theme-icon theme-icon-moon">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </span>
        <span class="theme-icon theme-icon-sun">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        </span>
      </button>
    </div>
  </footer>

  <script>
  (function () {
    const summaryWrap = document.getElementById('summary-wrap');
    const listHeaderWrap = document.getElementById('list-header-wrap');
    const layerList = document.getElementById('layer-list');
    const btnApplyAll = document.getElementById('btn-apply-all');
    const btnAutoScan = document.getElementById('btn-auto-scan');
    const btnTheme = document.getElementById('btn-theme');

    let isDark = false;
    const applyTheme = () => {
      document.documentElement.classList.toggle('dark', isDark);
    };
    if (btnTheme instanceof HTMLButtonElement) {
      btnTheme.addEventListener('click', () => {
        isDark = !isDark;
        applyTheme();
      });
    }

    const esc = (s) =>
      String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');

    const BADGE_CLASS = {
      'Text style': 'badge-ts',
      'Text style ãŒæ··åœ¨': 'badge-tm',
      'Fill color': 'badge-fill',
      'Stroke color': 'badge-stroke',
    };

    const getSeverity = (item) =>
      item.reasons.some((r) => r.severity === 'critical') ? 'critical' : 'warning';

    const STYLE_KIND_LABEL = {
      text: 'Text',
      fill: 'Fill',
      stroke: 'Stroke',
    };

    const REASON_LABEL_BY_KIND = {
      text: 'Text style',
      fill: 'Fill color',
      stroke: 'Stroke color',
    };

    const LABEL_TO_KIND = {
      'Text style': 'text',
      'Text style ãŒæ··åœ¨': 'text',
      'Fill color': 'fill',
      'Stroke color': 'stroke',
    };

    const pendingApplyLabelMap = new Map();
    let currentResult = null;
    let autoScanEnabled = true;
    let allTextStyleOptions = [];
    let allPaintStyleOptions = [];

    const updateAutoScanButton = () => {
      if (!(btnAutoScan instanceof HTMLInputElement)) {
        return;
      }
      btnAutoScan.checked = autoScanEnabled;
    };

    const getApplyButtonKey = (nodeId, kind, styleId) => `${nodeId}::${kind}::${styleId}`;

    const getApplyButtonSelector = (nodeId, kind, styleId) =>
      `.apply-btn[data-node-id="${CSS.escape(nodeId)}"][data-kind="${CSS.escape(kind)}"][data-style-id="${CSS.escape(styleId)}"]`;

    const recalcCounts = (result) => {
      let criticalCount = 0;
      let warningCount = 0;

      for (const layer of result.layers) {
        for (const reason of layer.reasons) {
          if (reason.severity === 'critical') criticalCount += 1;
          if (reason.severity === 'warning') warningCount += 1;
        }
      }

      result.criticalCount = criticalCount;
      result.warningCount = warningCount;
    };

    const getBulkTargets = (result) => {
      if (!result || !Array.isArray(result.layers)) {
        return { actions: [], layerCount: 0 };
      }

      const actions = [];
      for (const layer of result.layers) {
        if (!Array.isArray(layer.reasons) || layer.reasons.length === 0) {
          continue;
        }

        if (!Array.isArray(layer.suggestedStyles) || layer.suggestedStyles.length === 0) {
          continue;
        }

        for (const suggested of layer.suggestedStyles) {
          actions.push({
            nodeId: layer.id,
            kind: suggested.kind,
            styleId: suggested.styleId,
          });
        }
      }

      const layerCount = new Set(actions.map((action) => action.nodeId)).size;
      return { actions, layerCount };
    };

    const updateBulkApplyButton = () => {
      const { layerCount } = getBulkTargets(currentResult);
      btnApplyAll.textContent = `ä¸€æ‹¬é©ç”¨ï¼ˆ${layerCount}ï¼‰`;
      btnApplyAll.disabled = layerCount === 0;
    };

    const applyResultToCurrent = (result) => {
      if (!result.ok || !currentResult) {
        return;
      }

      const reasonLabel = REASON_LABEL_BY_KIND[result.kind];
      currentResult = {
        ...currentResult,
        layers: currentResult.layers.map((layer) => {
          if (layer.id !== result.nodeId) return layer;
          return {
            ...layer,
            reasons: layer.reasons.filter((r) => r.label !== reasonLabel),
            suggestedStyles: (layer.suggestedStyles || []).filter(
              (s) => !(s.kind === result.kind && s.styleId === result.styleId)
            ),
          };
        }),
      };
    };

    const renderFromResult = (msg) => {
      const hasOpenIssues = msg.layers.some((layer) => layer.reasons.length > 0);

      summaryWrap.innerHTML = `
        <div class="summary-grid">
          <div class="stat">
            <div class="stat-label">ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
            <div class="stat-num">${msg.scannedCount}</div>
          </div>
          <div class="stat ${msg.criticalCount === 0 ? 'is-resolved' : 'is-critical'}">
            <div class="stat-label">è¦ä¿®æ­£</div>
            <div class="stat-num">${msg.criticalCount}</div>
          </div>
          <div class="stat is-warning">
            <div class="stat-label">æœªå®šç¾©</div>
            <div class="stat-num">${msg.warningCount}</div>
          </div>
        </div>
      `;

      if (msg.layers.length === 0) {
        listHeaderWrap.innerHTML = '';
      } else if (hasOpenIssues) {
        const issueCount = msg.layers.filter((layer) => layer.reasons.length > 0).length;
        listHeaderWrap.innerHTML = `<div class="list-header">
            <span class="list-label">å•é¡Œã®ã‚ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼</span>
            <span class="list-count">${issueCount} ä»¶</span>
          </div>`;
      } else {
        listHeaderWrap.innerHTML = `<div class="list-header">
            <span class="list-label" style="color:var(--resolved);">å•é¡Œã¯ã™ã¹ã¦è§£æ¶ˆæ¸ˆã¿ã§ã™</span>
            <span class="list-count" style="color:var(--resolved);border-color:var(--resolved-bd);">${msg.layers.length} ä»¶</span>
          </div>`;
      }

      if (msg.layers.length === 0) {
        layerList.innerHTML = `<li class="state-box">
          <div class="state-icon">âœ…</div>
          <div class="state-title">å•é¡Œãªã—</div>
          <div class="state-desc">${msg.scannedCount} ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã—ãŸ<br>ã‚¹ã‚¿ã‚¤ãƒ«æœªé©ç”¨ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
        </li>`;
        return;
      }

      const SEV_LABEL = { critical: 'è¦ä¿®æ­£', warning: 'æœªå®šç¾©', resolved: 'è§£æ¶ˆ' };

      layerList.innerHTML = msg.layers
        .map((item) => {
          const hasIssues = item.reasons.length > 0;
          const sev = hasIssues ? getSeverity(item) : 'resolved';

          // å•é¡Œã”ã¨ã«1è¡Œ: [badge] [å€™è£œå] [é©ç”¨ãƒœã‚¿ãƒ³]
          const issueRows = hasIssues
            ? (() => {
                const styleByKind = new Map(
                  (item.suggestedStyles || []).map((s) => [s.kind, s])
                );
                return item.reasons
                  .map((r) => {
                    const kind = LABEL_TO_KIND[r.label];
                    const suggested = kind ? styleByKind.get(kind) : null;
                    const badgeClass = BADGE_CLASS[r.label] || 'badge-ts';
                    if (suggested) {
                      return `<div class="issue-row">
                        <span class="badge ${badgeClass}">${esc(r.label)}</span>
                        <span class="issue-val" title="${esc(suggested.styleName)}">${esc(suggested.styleName)}</span>
                        <button
                          class="apply-btn"
                          data-node-id="${esc(item.id)}"
                          data-kind="${esc(suggested.kind)}"
                          data-style-id="${esc(suggested.styleId)}"
                          title="${esc(suggested.styleName)}"
                        >${esc(STYLE_KIND_LABEL[suggested.kind] || suggested.kind)}é©ç”¨</button>
                      </div>`;
                    }
                    const selectKind = (kind === 'text' || kind === 'fill' || kind === 'stroke') && r.label !== 'Text style ãŒæ··åœ¨' ? kind : null;
                    if (selectKind) {
                      const opts = selectKind === 'text' ? allTextStyleOptions : allPaintStyleOptions;
                      const optionsHtml = opts.length > 0
                        ? opts.map((o) => `<option value="${esc(o.id)}">${esc(o.name)}</option>`).join('')
                        : '';
                      const selectHtml = `<select class="style-select" data-node-id="${esc(item.id)}" data-kind="${esc(selectKind)}">
                        <option value="">-- ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠ --</option>
                        ${optionsHtml}
                      </select>`;
                      const applyBtnHtml = `<button
                        class="apply-btn select-apply-btn"
                        disabled
                        data-node-id="${esc(item.id)}"
                        data-kind="${esc(selectKind)}"
                        data-style-id=""
                      >é©ç”¨</button>`;
                      return `<div class="issue-row">
                        <span class="badge ${badgeClass}">${esc(r.label)}</span>
                        ${selectHtml}
                        ${applyBtnHtml}
                      </div>`;
                    }
                    return `<div class="issue-row">
                      <span class="badge ${badgeClass}">${esc(r.label)}</span>
                      ${r.label !== 'Text style ãŒæ··åœ¨' ? '<span class="no-cand-label">å€™è£œãªã—</span>' : ''}
                    </div>`;
                  })
                  .join('');
              })()
            : `<div class="issue-row"><span class="badge badge-ok">å•é¡Œãªã—</span></div>`;

          return `<li>
            <div class="card ${sev}" data-node-id="${esc(item.id)}">
              <div class="card-head">
                <span class="layer-name">${esc(item.name || '(ç„¡å)')}</span>
                <span class="type-pill">${esc(item.nodeType)}</span>
                <span class="sev-pill ${sev}">${SEV_LABEL[sev]}</span>
              </div>
              <div class="layer-path">${esc(item.path)}</div>
              <div class="issue-list">${issueRows}</div>
            </div>
          </li>`;
        })
        .join('');
    };

    document.getElementById('btn-scan').addEventListener('click', () => {
      currentResult = null;
      summaryWrap.innerHTML = `<div class="summary-loading"><span class="spinner"></span>ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</div>`;
      listHeaderWrap.innerHTML = '';
      layerList.innerHTML = '';
      parent.postMessage({ pluginMessage: { type: 'scan' } }, '*');
      updateBulkApplyButton();
    });

    btnApplyAll.addEventListener('click', () => {
      if (!currentResult) {
        return;
      }

      const { actions, layerCount } = getBulkTargets(currentResult);
      if (actions.length === 0 || layerCount === 0) {
        updateBulkApplyButton();
        return;
      }

      btnApplyAll.disabled = true;
      btnApplyAll.textContent = `ä¸€æ‹¬é©ç”¨ä¸­...ï¼ˆ${layerCount}ï¼‰`;
      parent.postMessage({ pluginMessage: { type: 'apply-bulk', actions } }, '*');
    });

    if (btnAutoScan instanceof HTMLInputElement) {
      btnAutoScan.addEventListener('change', () => {
        autoScanEnabled = btnAutoScan.checked;
        parent.postMessage(
          { pluginMessage: { type: 'set-auto-scan', enabled: autoScanEnabled } },
          '*'
        );
      });
      updateAutoScanButton();
      // èµ·å‹•æ™‚ã« Plugin å´ã¸åˆæœŸçŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹ï¼ˆinitial: true ã§ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      parent.postMessage({ pluginMessage: { type: 'set-auto-scan', enabled: autoScanEnabled, initial: true } }, '*');
    }

    layerList.addEventListener('change', (e) => {
      const styleSelect = e.target;
      if (!(styleSelect instanceof HTMLSelectElement) || !styleSelect.classList.contains('style-select')) return;
      const row = styleSelect.closest('.issue-row');
      if (!row) return;
      const applyBtn = row.querySelector('.select-apply-btn');
      if (!(applyBtn instanceof HTMLButtonElement)) return;
      const selectedId = styleSelect.value;
      applyBtn.disabled = !selectedId;
      applyBtn.dataset.styleId = selectedId;
    });

    layerList.addEventListener('click', (e) => {
      // ã‚»ãƒ¬ã‚¯ãƒˆãƒ»å€™è£œåã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ã—ãªã„
      if (e.target.closest('.style-select') || e.target.closest('.issue-val')) return;

      // é©ç”¨ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯
      const applyBtn = e.target.closest('.apply-btn');
      if (applyBtn instanceof HTMLElement) {
        const nodeId = applyBtn.dataset.nodeId;
        const kind = applyBtn.dataset.kind;
        const styleId = applyBtn.dataset.styleId;
        if (nodeId && styleId && (kind === 'text' || kind === 'fill' || kind === 'stroke')) {
          const key = getApplyButtonKey(nodeId, kind, styleId);
          pendingApplyLabelMap.set(key, applyBtn.textContent || `${STYLE_KIND_LABEL[kind]}é©ç”¨`);
          applyBtn.disabled = true;
          applyBtn.classList.add('applying');
          applyBtn.textContent = 'é©ç”¨ä¸­...';
          parent.postMessage({ pluginMessage: { type: 'apply-style', nodeId, kind, styleId } }, '*');
        }
        return; // é©ç”¨ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ã—ãªã„
      }

      // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠä¸­ã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ã—ãªã„
      const sel = window.getSelection();
      if (sel && sel.toString().length > 0) return;

      // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ç§»å‹•
      const card = e.target.closest('.card');
      if (!(card instanceof HTMLElement)) return;
      const nodeId = card.dataset.nodeId;
      if (nodeId) {
        parent.postMessage({ pluginMessage: { type: 'focus-node', nodeId } }, '*');
      }
    });

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'auto-scan-state') {
        autoScanEnabled = !!msg.enabled;
        updateAutoScanButton();
        return;
      }

      if (msg.type === 'no-selection') {
        summaryWrap.innerHTML = `<div class="summary-placeholder">â–¸ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ã‚¹ã‚­ãƒ£ãƒ³</div>`;
        listHeaderWrap.innerHTML = '';
        layerList.innerHTML = `<li class="state-box">
          <div class="state-icon">ğŸ‘†</div>
          <div class="state-title">æœªé¸æŠ</div>
          <div class="state-desc">ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’<br>Figma ä¸Šã§é¸æŠã—ã¦ãã ã•ã„</div>
        </li>`;
        updateBulkApplyButton();
        return;
      }

      if (msg.type === 'apply-style-result') {
        const key = getApplyButtonKey(msg.nodeId, msg.kind, msg.styleId);
        const selector = getApplyButtonSelector(msg.nodeId, msg.kind, msg.styleId);
        const btn = layerList.querySelector(selector);

        if (btn instanceof HTMLButtonElement) {
          btn.classList.remove('applying');

          if (msg.ok) {
            // issue-row ã‚’å‰Šé™¤ã—ã€ã‚«ãƒ¼ãƒ‰ã‚’å¤–ç§‘çš„ã«æ›´æ–°ï¼ˆå…¨ãƒªã‚¹ãƒˆå†æç”»ãªã—ï¼‰
            const row = btn.closest('.issue-row');
            const cardEl = btn.closest('.card'); // row å‰Šé™¤å‰ã«å‚ç…§å–å¾—
            if (row) row.remove();

            if (cardEl instanceof HTMLElement) {
              const issueList = cardEl.querySelector('.issue-list');
              const remaining = issueList ? issueList.querySelectorAll('.issue-row').length : 0;
              if (remaining === 0) {
                // ã™ã¹ã¦è§£æ±ºæ¸ˆã¿: ã‚«ãƒ¼ãƒ‰å¤–è¦³ã‚’æ›´æ–°
                cardEl.className = 'card resolved';
                const sevPill = cardEl.querySelector('.sev-pill');
                if (sevPill) {
                  sevPill.className = 'sev-pill resolved';
                  sevPill.textContent = 'è§£æ¶ˆ';
                }
                if (issueList) {
                  issueList.innerHTML = '<div class="issue-row"><span class="badge badge-ok">å•é¡Œãªã—</span></div>';
                }
              }
            }
          } else {
            const original = pendingApplyLabelMap.get(key) || `${STYLE_KIND_LABEL[msg.kind] || msg.kind}é©ç”¨`;
            btn.disabled = false;
            btn.textContent = original;
          }
        }

        if (msg.ok && currentResult) {
          applyResultToCurrent(msg);
          recalcCounts(currentResult);

          // ã‚µãƒãƒªãƒ¼ã®æ•°å€¤ã ã‘æ›´æ–°ï¼ˆãƒªã‚¹ãƒˆå…¨ä½“ã¯å†æç”»ã—ãªã„ï¼‰
          const grid = summaryWrap.querySelector('.summary-grid');
          if (grid) {
            const stats = grid.querySelectorAll('.stat');
            if (stats.length >= 3) {
              stats[1].className = `stat ${currentResult.criticalCount === 0 ? 'is-resolved' : 'is-critical'}`;
              const critNum = stats[1].querySelector('.stat-num');
              if (critNum) critNum.textContent = currentResult.criticalCount;
              const warnNum = stats[2].querySelector('.stat-num');
              if (warnNum) warnNum.textContent = currentResult.warningCount;
            }
          }

          updateBulkApplyButton();
        }

        pendingApplyLabelMap.delete(key);
        return;
      }

      if (msg.type === 'apply-bulk-result') {
        if (currentResult && Array.isArray(msg.results)) {
          for (const result of msg.results) {
            applyResultToCurrent(result);
          }

          recalcCounts(currentResult);
          renderFromResult(currentResult);
          updateBulkApplyButton();
        }

        return;
      }

      if (msg.type !== 'scan-result') return;

      allTextStyleOptions = Array.isArray(msg.textStyleOptions) ? msg.textStyleOptions : [];
      allPaintStyleOptions = Array.isArray(msg.paintStyleOptions) ? msg.paintStyleOptions : [];

      currentResult = {
        scannedCount: msg.scannedCount,
        layers: Array.isArray(msg.layers) ? msg.layers : [],
        textReasonCount: msg.textReasonCount,
        colorReasonCount: msg.colorReasonCount,
        criticalCount: msg.criticalCount,
        warningCount: msg.warningCount,
      };

      recalcCounts(currentResult);
      renderFromResult(currentResult);
      updateBulkApplyButton();
    };
  })();
  </script>
</body>
</html>
